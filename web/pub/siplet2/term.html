<HTML><BODY><PRE ID=BOB>
<SCRIPT LANGUAGE=JavaScript src="js/siplet.js"></SCRIPT>
<SCRIPT LANGUAGE=JavaScript src="js/binparser.js"></SCRIPT>
<SCRIPT LANGUAGE=JavaScript src="js/ansiparser.js"></SCRIPT>
<SCRIPT LANGUAGE=JavaScript src="js/telnetparser.js"></SCRIPT>
<SCRIPT LANGUAGE=JavaScript src="js/mspsupport.js"></SCRIPT>
<SCRIPT LANGUAGE=JavaScript>
var siplet = JSON.parse(JSON.stringify(Siplet)); // makes a deep copy
var wsocket;
var wsopened = false;
var windowName = '0';
var binblock = new BPPARSE();
binblock.nolf = true;
var ansipage = new ANSISTACK();
var telnet = new TELNET(siplet);
var msp = new MSP(telnet, windowName);
var termWindow = document.getElementById('BOB');
wsocket = new WebSocket("ws://localhost:27744/WebSock");
wsocket.binaryType = "arraybuffer";
function onmessage(e)
{
	binblock.data = event.data;
	binparse(binblock);
	var html = "";
	if (termWindow.childNodes.length > siplet.maxLines)
		termWindow.removeChild(termWindow.firstChild);
	var scroll=false;
	while(binblock.entries.length > 0)
	{
		if((binblock.entries.length == 1)
		&&(!binblock.entries[0].done))
			break;
		var blk = binblock.entries.shift();
		if(blk.data.length==0)
			continue;
		if(blk.type == BPTYPE.TEXT)
		{
			//TODO: this is not going to support utf-16 well 
			for (var i=0; i < blk.data.length; i++) {
				html += String.fromCharCode( blk.data[i]);
			}
			if((html.length>0)&&(html[html.length-1]=='\n'))
			{
				html = msp.process(html);
				var span = document.createElement('span');
				span.innerHTML = html;
				termWindow.appendChild(span);
				html='';
				scroll=true;
			}
		}
		else
		if(blk.type == BPTYPE.ANSI)
			html += ansipage.ansiparser(blk.data)
		else
		if(blk.type == BPTYPE.TELNET)
		{
			var buffer = telnet.process(blk.data);
			if ((buffer.byteLength > 0) && (wsopened))
				wsocket.send(buffer);
		}
	}
	if(html.length > 0)
	{
		var span = document.createElement('span');
		html = msp.process(html);
		span.innerHTML = html;
		termWindow.appendChild(span);
		scroll=true;
	}
	if(scroll)
		window.scrollTo(0, document.body.scrollHeight);
}

function onkeypress(e)
{
	termWindow.innerHTML +=String.fromCharCode(event.keyCode);
	if(wsopened)
		wsocket.send(String.fromCharCode(event.keyCode));
}

wsocket.onmessage = onmessage;
wsocket.onopen = function(event)  
{
	wsopened=true; 
	document.bgColor="black";
	document.fgColor="white";
};
wsocket.onclose = function(event)  
{ 
	wsopened=false; 
	document.bgColor="red";
};
document.onkeypress = onkeypress;
</SCRIPT></PRE></BODY><HTML>